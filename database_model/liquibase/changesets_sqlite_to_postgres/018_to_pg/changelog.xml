<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd
    http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd"
		 logicalFilePath="018_to_pg/changelog.xml">

	<changeSet author="patrick_schmitz" id="018_to_pg">

        <sql dbms="postgresql">
		<![CDATA[
		INSERT INTO databasechangelog (id, author, filename, dateexecuted, orderexecuted, exectype, md5sum, description, "comments", tag, liquibase, contexts, labels)
		SELECT
			"ID",
			"AUTHOR",
			"FILENAME",
			CAST("DATEEXECUTED" AS TIMESTAMP),
			"ORDEREXECUTED",
			"EXECTYPE",
			"MD5SUM",
			"DESCRIPTION",
			"COMMENTS",
			"TAG",
			"LIQUIBASE",
			"CONTEXTS",
			"LABELS"
		FROM
			"DATABASECHANGELOG" for_inserting
		LEFT JOIN databasechangelog existing ON 1=1
		AND existing.id = for_inserting."ID"
		AND existing.filename = for_inserting."FILENAME"
		WHERE 1=1
		AND existing.id IS NULL
		;
        ]]>
		</sql>		
		<rollback>
			<sql dbms="postgresql">
			<![CDATA[
			DELETE FROM databasechangelog
			WHERE id NOT LIKE '%\_pg'
			;
			]]>
			</sql>		
		</rollback>
		<comment>
		<![CDATA[
		Take over databasechangelog from SQLite (in uppercase) into PostgreSQL.
		Phabricator tasks:
			T281
		]]>
		</comment>
	</changeSet>
</databaseChangeLog>
