<?xml version="1.0" encoding="UTF-8"?>

	<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd
    http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd"
	
	logicalFilePath="000158/changelog.xml">

	<changeSet author="patrick_schmitz" id="000158">


        <sql dbms="postgresql">
        <![CDATA[
        DROP VIEW "v_db_table_field_SearchInterface";

        CREATE VIEW "v_db_table_field_SearchInterface" AS
        WITH RECURSIVE split(seq, word, str, id, fk_project_id, location) AS (
            SELECT 0, '.', location||'.',id,fk_project_id,location
            FROM db_table_cte 
            WHERE 1=1 
            AND location LIKE '%.%.%'
            UNION ALL SELECT
                seq+1,
                substr(str, 0, instr(str, '.')),
                substr(str, instr(str, '.')+1),
                id,
                fk_project_id,
                location
            FROM split WHERE str != ''
        )
        ,db_table_cte AS 
        (
            SELECT * FROM db_table
        )
        SELECT
            db_table_field.id
            ,COALESCE(CAST(db_table_field.uuid AS varchar(100)), '') AS uuid
            ,db_table_field.fk_object_type_id
            ,project.fk_client_id
            ,COALESCE(project.name, '') AS project_name
            ,COALESCE(client.name, '') AS client_name
            ,db_table_field.fk_project_id
            ,COALESCE(db_table_field.name, '') AS name
            ,COALESCE(db_table_field.description, '') AS description
            ,db_table_field.fk_db_table_id
            ,COALESCE(db_table_field.datatype, '') AS datatype
            ,COALESCE(db_table_field.bulk_load_checksum, '') AS bulk_load_checksum
            ,db_table_field.fk_deleted_status_id
            ,db_table_field."is_PrimaryKey"
            ,db_table_field."is_BusinessKey"
            ,db_table_field."is_GDPR_relevant"
            ,db_table_field.fk_object_persistence_method_id
            ,db_table_field.fk_datamanagement_process_id
            ,COALESCE(db_table_field.source_definition, '') AS source_definition
            ,COALESCE(db_table_field.source_comment, '') AS source_comment
            ,CASE WHEN (LENGTH(db_table.location) - LENGTH(REPLACE(db_table.location, '"."', ''))) / LENGTH('"."')>=2 THEN REPLACE(SUBSTR(db_table.location ,1, INSTR(db_table.location,'.')-1),'"','') ELSE '' END AS databaseInfoFromLocation
            ,CASE WHEN (LENGTH(db_table.location) - LENGTH(REPLACE(db_table.location, '"."', ''))) / LENGTH('"."')>=2 THEN REPLACE(location_schema_extract.word, '"', '') ELSE '' END AS schemaInfoFromLocation
            ,tags.tags_csv
            ,tags.tags_html_li
        FROM db_table_field
        LEFT JOIN project ON project.id = db_table_field.fk_project_id
        LEFT JOIN client ON client.id = project.fk_client_id
        LEFT JOIN db_table_cte db_table ON db_table.id = db_table_field.fk_db_table_id
        LEFT JOIN split location_schema_extract ON location_schema_extract.id = db_table.id AND location_schema_extract.seq=2
        LEFT JOIN (
            SELECT
              mot.ref_fk_object_id,
              mot.ref_fk_object_type_id,
              STRING_AGG(t.name, '; ' ORDER BY t.name) AS tags_csv, 
              '<ul style="list-style-type: none; padding: 0;">'||STRING_AGG('<li style="background-color: lightblue; margin: 5px 0; padding: 5px; border-radius: 10px;">'||t.name||'</li>', '')||'</ul>' AS tags_html_li
            FROM map_object_2_tag mot
            LEFT JOIN tag t ON 1=1
              AND t.id=mot.fk_tag_id
            WHERE ref_fk_object_type_id=5
            GROUP BY mot.ref_fk_object_id,ref_fk_object_type_id
        ) tags ON 1=1
            AND tags.ref_fk_object_id = db_table_field.id
            AND tags.ref_fk_object_type_id = db_table_field.fk_object_type_id
        ;
        ]]>
		</sql>				

        <sql dbms="sqlite">
        <![CDATA[
        DROP VIEW "v_db_table_field_SearchInterface";

        CREATE VIEW "v_db_table_field_SearchInterface" AS
        WITH RECURSIVE split(seq, word, str, id, fk_project_id, location) AS (
            SELECT 0, '.', location||'.',id,fk_project_id,location
            FROM db_table_cte 
            WHERE 1=1 
            AND location LIKE '%.%.%'
            UNION ALL SELECT
                seq+1,
                substr(str, 0, instr(str, '.')),
                substr(str, instr(str, '.')+1),
                id,
                fk_project_id,
                location
            FROM split WHERE str != ''
        )
        ,db_table_cte AS 
        (
            SELECT * FROM db_table
        )
        SELECT
            db_table_field.id
            ,COALESCE(CAST(db_table_field.uuid AS varchar(100)), '') AS uuid
            ,db_table_field.fk_object_type_id
            ,project.fk_client_id
            ,COALESCE(project.name, '') AS project_name
            ,COALESCE(client.name, '') AS client_name
            ,db_table_field.fk_project_id
            ,COALESCE(db_table_field.name, '') AS name
            ,COALESCE(db_table_field.description, '') AS description
            ,db_table_field.fk_db_table_id
            ,COALESCE(db_table_field.datatype, '') AS datatype
            ,COALESCE(db_table_field.bulk_load_checksum, '') AS bulk_load_checksum
            ,db_table_field.fk_deleted_status_id
            ,db_table_field."is_PrimaryKey"
            ,db_table_field."is_BusinessKey"
            ,db_table_field."is_GDPR_relevant"
            ,db_table_field.fk_object_persistence_method_id
            ,db_table_field.fk_datamanagement_process_id
            ,COALESCE(db_table_field.source_definition, '') AS source_definition
            ,COALESCE(db_table_field.source_comment, '') AS source_comment
            ,CASE WHEN (LENGTH(db_table.location) - LENGTH(REPLACE(db_table.location, '"."', ''))) / LENGTH('"."')>=2 THEN REPLACE(SUBSTR(db_table.location ,1, INSTR(db_table.location,'.')-1),'"','') ELSE '' END AS databaseInfoFromLocation
            ,CASE WHEN (LENGTH(db_table.location) - LENGTH(REPLACE(db_table.location, '"."', ''))) / LENGTH('"."')>=2 THEN REPLACE(location_schema_extract.word, '"', '') ELSE '' END AS schemaInfoFromLocation
			,tags.tags_csv
			,tags.tags_html_li
        FROM db_table_field
        LEFT JOIN project ON project.id = db_table_field.fk_project_id
        LEFT JOIN client ON client.id = project.fk_client_id
        LEFT JOIN db_table_cte db_table ON db_table.id = db_table_field.fk_db_table_id
        LEFT JOIN split location_schema_extract ON location_schema_extract.id = db_table.id AND location_schema_extract.seq=2
		LEFT JOIN (
			SELECT
			  mot.ref_fk_object_id,
			  mot.ref_fk_object_type_id,
			  GROUP_CONCAT(t.name, '; ') AS tags_csv, 
			  '<ul style="list-style-type: none; padding: 0;">'||GROUP_CONCAT('<li style="background-color: lightblue; margin: 5px 0; padding: 5px; border-radius: 10px;">'||t.name||'</li>', '')||'</ul>' AS tags_html_li
			FROM map_object_2_tag mot
			LEFT JOIN tag t ON 1=1
			  AND t.id=mot.fk_tag_id
			WHERE ref_fk_object_type_id=5
			GROUP BY mot.ref_fk_object_id,ref_fk_object_type_id
			ORDER BY t.name
		) tags ON 1=1
		    AND tags.ref_fk_object_id = db_table_field.id
			AND tags.ref_fk_object_type_id = db_table_field.fk_object_type_id
        ;
        ]]>
		</sql>		
		<comment>
		<![CDATA[
		Take over custom implementation.
		Used objects:
			v_db_table_field_SearchInterface
		Phabricator tasks:
            T412
            T587
		]]>
		</comment>
</changeSet>
</databaseChangeLog>
